// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Authentication and User Management
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

enum UserRole {
  ADMIN
  MANAGER      // Full access except finances
  TECHNICIAN   // Maintenance assignments
  CLIENT       // Customer access
  VIEWER
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  password      String?   // Hashed password for email/password auth
  image         String?
  role          UserRole  @default(CLIENT)
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  accounts Account[]
  sessions Session[]

  // Employee/Admin fields
  employeeId    String?   @unique
  department    String?
  permissions   Permission[]

  // System audit
  createdOrders Order[]
  createdMaintenanceRecords MaintenanceRecord[]

  // Maintenance assignments
  assignedMaintenances MaintenanceTechnician[]
  maintenanceStatusChanges MaintenanceStatusHistory[]

  // Notifications
  notifications Notification[]

  // Payments received
  paymentsReceived Payment[] @relation("PaymentsReceived")

  // Systems installed
  installedSystems SolarSystem[]

  @@map("users")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Permission {
  id     String @id @default(cuid())
  userId String
  resource String // 'clients', 'inventory', 'orders', 'maintenance', 'reports'
  actions  String // 'create,read,update,delete' - comma separated
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([userId, resource])
}

// Client Management
model Client {
  id          String   @id @default(cuid())
  firstName   String
  lastName    String
  email       String   @unique
  phone       String?
  password    String?  // Hashed password for client login
  requirePasswordChange Boolean @default(true) // Force password change on first login
  address     String?
  city        String?
  state       String?
  postalCode  String?
  notes       String?
  profileImage String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Temporary fiscal fields (until FiscalData table is properly set up)
  rfc         String?
  curp        String?
  regimenFiscal String?
  identificationNumber String? // INE/IFE number
  neighborhood String?

  // Growatt Integration fields
  growattUsername String?
  growattPassword String? // Should be encrypted in production
  expectedDailyGeneration Decimal? @db.Decimal(8, 2) // kWh per day

  // Mexican Tax/Fiscal Information
  fiscalData  FiscalData?

  // Business relationships
  orders           Order[]
  maintenanceRecords MaintenanceRecord[]
  solarSystems     SolarSystem[]
  growattCredentials GrowattCredentials[]
  growattHistory   GrowattDailyHistory[]
  notifications    Notification[]
  cfeReceipts      CfeReceipt[]
  addresses        ClientAddress[]

  @@map("clients")
}

// Client Addresses (multiple addresses per client)
model ClientAddress {
  id           String   @id @default(cuid())
  clientId     String
  name         String   // e.g., "Casa Principal", "Sucursal Norte"
  address      String?
  city         String?
  state        String?
  postalCode   String?
  neighborhood String?
  isDefault    Boolean  @default(false)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  client       Client       @relation(fields: [clientId], references: [id], onDelete: Cascade)
  cfeReceipts  CfeReceipt[]
  solarSystems SolarSystem[]
  orders       Order[]

  @@index([clientId])
  @@map("client_addresses")
}

// CFE Receipt Data (Comisión Federal de Electricidad)
model CfeReceipt {
  id                String   @id @default(cuid())
  clientId          String
  addressId         String?  // Link to specific address
  name              String?  // e.g., "Medidor Principal", "Medidor Bodega"
  rpu               String?  // Registro Permanente Único
  serviceNumber     String?  // Número de servicio CFE
  meterNumber       String?  // Número de medidor
  rmu               String?  // RMU
  accountNumber     String?  // Número de cuenta CFE
  meterType         String?  // Tipo de medidor (Digital, Analógico)
  tariff            String?  // Tarifa (1, 1A, 1B, 1C, DAC, etc.)
  phases            Int?     // Número de fases
  wires             Int?     // Número de hilos
  installedLoad     Decimal? @db.Decimal(10, 2) // Carga instalada (kW)
  contractedDemand  Decimal? @db.Decimal(10, 2) // Demanda contratada (kW)
  voltageLevel      Decimal? @db.Decimal(10, 2) // Nivel de tensión (V)
  mediumVoltage     Boolean  @default(false) // Media tensión
  cfeBranch         String?  // Sucursal CFE
  cfeFolio          String?  // Folio CFE
  receiptFileUrl    String?  // URL del archivo del recibo CFE (Supabase Storage)
  notes             String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  client       Client         @relation(fields: [clientId], references: [id], onDelete: Cascade)
  address      ClientAddress? @relation(fields: [addressId], references: [id], onDelete: SetNull)
  solarSystems SolarSystem[]
  orders       Order[]

  @@index([clientId])
  @@index([addressId])
  @@map("cfe_receipts")
}

model FiscalData {
  id            String @id @default(cuid())
  clientId      String @unique
  razonSocial   String
  rfc           String @unique
  email         String?
  telefono      String?
  calle         String?
  numero        String?
  colonia       String?
  codigoPostal  String?
  ciudad        String?
  estado        String?
  regimenFiscalId String
  usoCFDIId     String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  client        Client       @relation(fields: [clientId], references: [id], onDelete: Cascade)
  regimenFiscal RegimenFiscal @relation(fields: [regimenFiscalId], references: [id], onUpdate: NoAction, onDelete: NoAction)
  usoCFDI       UsoCFDI      @relation(fields: [usoCFDIId], references: [id], onUpdate: NoAction, onDelete: NoAction)

  @@map("fiscal_data")
}

model RegimenFiscal {
  id          String @id @default(cuid())
  code        String @unique // SAT Code
  descripcion String
  isActive    Boolean @default(true)

  fiscalData FiscalData[]
  usoCFDIs   UsoCFDI[]

  @@map("regimen_fiscal")
}

model UsoCFDI {
  id              String @id @default(cuid())
  code            String @unique // SAT Code  
  descripcion     String
  regimenFiscalId String
  isActive        Boolean @default(true)

  regimenFiscal RegimenFiscal @relation(fields: [regimenFiscalId], references: [id])
  fiscalData    FiscalData[]

  @@map("uso_cfdi")
}

// Inventory Management
model ProductCategory {
  id          String @id @default(cuid())
  name        String @unique // Paneles, Calentadores, Inversores, Refacciones
  description String?
  isActive    Boolean @default(true)
  
  subCategories ProductSubCategory[]
  products      Product[]

  @@map("product_categories")
}

model ProductSubCategory {
  id         String @id @default(cuid())
  name       String // Alta Presion, Baja Presion, Aislados, Interconexion, etc.
  categoryId String
  isActive   Boolean @default(true)
  
  category ProductCategory @relation(fields: [categoryId], references: [id])
  products Product[]

  @@unique([categoryId, name])
  @@map("product_sub_categories")
}

model Location {
  id       String @id @default(cuid())
  name     String @unique
  address  String?
  isActive Boolean @default(true)
  
  inventoryItems InventoryItem[]

  @@map("locations")
}

model Product {
  id            String  @id @default(cuid())
  name          String
  brand         String?
  model         String?
  capacity      String?
  description   String?
  barcode       String?  // Código de barras del producto (no único - identifica tipo de producto)
  unitPrice     Decimal? @db.Decimal(10, 2)
  categoryId    String
  subCategoryId String?
  isActive      Boolean @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  category    ProductCategory     @relation(fields: [categoryId], references: [id], onUpdate: NoAction, onDelete: NoAction)
  subCategory ProductSubCategory? @relation(fields: [subCategoryId], references: [id], onUpdate: NoAction, onDelete: NoAction)
  
  inventoryItems InventoryItem[]
  orderItems     OrderItem[]
  solarSystemComponents SolarSystemComponent[]

  @@map("products")
}

model InventoryItem {
  id            String   @id @default(cuid())
  productId     String
  locationId    String
  quantity      Int
  serialNumber  String?
  invoiceNumber String?
  purchaseDate  DateTime?
  supplier      String?
  unitCost      Decimal?  @db.Decimal(10, 2)
  totalCost     Decimal?  @db.Decimal(10, 2)
  notes         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  product  Product  @relation(fields: [productId], references: [id])
  location Location @relation(fields: [locationId], references: [id])

  // Inventory movements
  movementsOut InventoryMovement[] @relation("MovementFrom")
  movementsIn  InventoryMovement[] @relation("MovementTo")

  // Maintenance parts
  maintenanceParts MaintenancePart[]

  @@unique([productId, locationId, serialNumber])
  @@map("inventory_items")
}

model InventoryMovement {
  id              String            @id @default(cuid())
  type            String            // PURCHASE, SALE, TRANSFER, ADJUSTMENT, MAINTENANCE, RETURN
  quantity        Int
  fromItemId      String?
  toItemId        String?
  orderId         String?
  maintenanceId   String?
  reason          String?
  notes           String?
  createdAt       DateTime @default(now())
  createdBy       String?

  fromItem     InventoryItem? @relation("MovementFrom", fields: [fromItemId], references: [id], onUpdate: NoAction, onDelete: NoAction)
  toItem       InventoryItem? @relation("MovementTo", fields: [toItemId], references: [id], onUpdate: NoAction, onDelete: NoAction)
  order        Order?         @relation(fields: [orderId], references: [id])
  maintenance  MaintenanceRecord? @relation(fields: [maintenanceId], references: [id])

  @@map("inventory_movements")
}

// Order Management
model Order {
  id            String      @id @default(cuid())
  orderNumber   String      @unique
  clientId      String
  addressId     String?     // Link to specific delivery address
  cfeReceiptId  String?     // Link to specific meter (for installation orders)
  status        String      @default("DRAFT") // DRAFT, CONFIRMED, IN_PROGRESS, SHIPPED, DELIVERED, COMPLETED, CANCELLED
  orderType     String      @default("SALE") // SALE, INSTALLATION, MAINTENANCE, WARRANTY
  orderDate     DateTime    @default(now())
  requiredDate  DateTime?
  shippingDate  DateTime?
  completedDate DateTime?

  // Financial
  subtotal      Decimal     @db.Decimal(12, 2)
  taxRate       Decimal     @default(0.16) @db.Decimal(5, 4) // IVA 16%
  taxAmount     Decimal     @db.Decimal(12, 2)
  total         Decimal     @db.Decimal(12, 2)

  // Payment tracking
  depositRequired    Boolean  @default(false)
  depositPercentage  Decimal? @db.Decimal(5, 2) @default(50)
  depositAmount      Decimal? @db.Decimal(10, 2)
  amountPaid         Decimal  @default(0) @db.Decimal(10, 2)
  balanceDue         Decimal? @db.Decimal(10, 2)
  paymentStatus      String   @default("PENDING") // PENDING, PARTIAL, PAID, REFUNDED

  // Shipping
  shippingAddress String?
  notes          String?

  // System
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  createdBy      String?

  client            Client             @relation(fields: [clientId], references: [id])
  address           ClientAddress?     @relation(fields: [addressId], references: [id], onUpdate: NoAction, onDelete: NoAction)
  cfeReceipt        CfeReceipt?        @relation(fields: [cfeReceiptId], references: [id], onUpdate: NoAction, onDelete: NoAction)
  createdByUser     User?              @relation(fields: [createdBy], references: [id])
  orderItems        OrderItem[]
  invoice           Invoice?
  inventoryMovements InventoryMovement[]
  maintenanceRecords MaintenanceRecord[]
  solarSystems      SolarSystem[]
  payments          Payment[]

  @@map("orders")
}

model OrderItem {
  id            String   @id @default(cuid())
  orderId       String
  productId     String
  quantity      Int
  unitPrice     Decimal  @db.Decimal(10, 2)
  discount      Decimal  @default(0) @db.Decimal(10, 2)
  totalPrice    Decimal  @db.Decimal(12, 2)
  notes         String?
  serialNumbers String[] @default([]) // Números de serie escaneados de cada unidad

  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@map("order_items")
}

// Payment Management
model Payment {
  id              String   @id @default(cuid())
  orderId         String
  amount          Decimal  @db.Decimal(10, 2)
  paymentType     String   @default("PARTIAL") // DEPOSIT, PARTIAL, FINAL, REFUND
  paymentMethod   String?  // CASH, TRANSFER, CARD, CHECK
  paymentDate     DateTime @default(now())
  referenceNumber String?
  notes           String?
  receivedById    String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  order      Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
  receivedBy User? @relation("PaymentsReceived", fields: [receivedById], references: [id], onUpdate: NoAction, onDelete: NoAction)

  @@index([orderId])
  @@index([paymentDate])
  @@map("payments")
}

// Invoice Management (SAT Compliance)
model Invoice {
  id              String        @id @default(cuid())
  invoiceNumber   String        @unique
  orderId         String        @unique
  clientId        String
  
  // SAT Fields
  uuid            String?       @unique // UUID del SAT
  rfcEmisor       String
  rfcReceptor     String
  regimenFiscal   String
  usoCFDI         String
  metodoPago      String        @default("PUE") // PUE, PPD
  formaPago       String        @default("03")  // Transferencia
  
  // Financial
  subtotal        Decimal       @db.Decimal(12, 2)
  iva             Decimal       @db.Decimal(12, 2)
  total           Decimal       @db.Decimal(12, 2)
  
  // Status
  status          String        @default("PENDING") // PENDING, ISSUED, PAID, CANCELLED, OVERDUE
  issuedAt        DateTime?
  cancelledAt     DateTime?
  
  // XML/PDF Storage
  xmlPath         String?
  pdfPath         String?
  
  // System
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  order         Order @relation(fields: [orderId], references: [id])
  invoiceItems  InvoiceItem[]

  @@map("invoices")
}

model InvoiceItem {
  id          String  @id @default(cuid())
  invoiceId   String
  productCode String  // Clave SAT del producto
  description String
  unit        String  @default("PZA")
  quantity    Decimal @db.Decimal(10, 3)
  unitPrice   Decimal @db.Decimal(10, 2)
  amount      Decimal @db.Decimal(12, 2)

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@map("invoice_items")
}

// Solar System Management
model SolarSystem {
  id               String   @id @default(cuid())
  systemName       String
  clientId         String
  orderId          String?
  addressId        String?  // Link to specific address
  cfeReceiptId     String?  // Link to specific meter/CFE receipt
  installationDate DateTime?
  capacity         Decimal? @db.Decimal(8, 2) // kW
  estimatedGeneration Decimal? @db.Decimal(10, 2) // kWh/year
  warrantyUntil    DateTime?
  notes            String?
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Installation tracking
  installationStatus         String    @default("PENDING_SCHEDULING") // PENDING_SCHEDULING, SCHEDULED, IN_PROGRESS, INSTALLED, CFE_SUBMITTED, CFE_APPROVED, INTERCONNECTED, ON_HOLD
  annexDate                  DateTime?
  scheduledInstallationDate  DateTime?
  installationCompletedDate  DateTime?
  cfeSubmissionDate          DateTime?
  cfeApprovalDate            DateTime?
  interconnectionDate        DateTime?
  installationNotes          String?
  installedById              String?

  client             Client              @relation(fields: [clientId], references: [id], onUpdate: NoAction)
  order              Order?              @relation(fields: [orderId], references: [id], onUpdate: NoAction, onDelete: NoAction)
  address            ClientAddress?      @relation(fields: [addressId], references: [id], onUpdate: NoAction, onDelete: NoAction)
  cfeReceipt         CfeReceipt?         @relation(fields: [cfeReceiptId], references: [id], onUpdate: NoAction, onDelete: NoAction)
  installedBy        User?               @relation(fields: [installedById], references: [id], onUpdate: NoAction, onDelete: NoAction)
  components         SolarSystemComponent[]
  maintenanceRecords MaintenanceRecord[]
  energyReadings     EnergyReading[]

  @@map("solar_systems")
}

model SolarSystemComponent {
  id             String @id @default(cuid())
  solarSystemId  String
  productId      String
  serialNumber   String?
  quantity       Int
  installationDate DateTime?
  warrantyUntil  DateTime?
  notes          String?

  solarSystem SolarSystem @relation(fields: [solarSystemId], references: [id], onDelete: Cascade)
  product     Product     @relation(fields: [productId], references: [id])

  @@map("solar_system_components")
}

// Maintenance Management Enums
enum MaintenanceType {
  PREVENTIVE
  CORRECTIVE
  WARRANTY
  CLEANING
}

enum MaintenancePriority {
  SCHEDULED
  URGENT
}

enum MaintenanceStatus {
  PENDING_APPROVAL
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

model MaintenanceRecord {
  id              String              @id @default(cuid())
  clientId        String
  solarSystemId   String?
  orderId         String?

  // Type and priority
  type            MaintenanceType
  priority        MaintenancePriority @default(SCHEDULED)
  status          MaintenanceStatus   @default(PENDING_APPROVAL)

  // Dates
  requestedDate   DateTime            @default(now())
  scheduledDate   DateTime?
  startedDate     DateTime?
  completedDate   DateTime?

  // Details
  title           String
  description     String?
  workPerformed   String?
  privateNotes    String?             // Only visible to admin/manager/technicians

  // Service costs
  laborHours      Decimal?            @db.Decimal(5, 2)
  cost            Decimal?            @db.Decimal(10, 2)

  // Auto-generation
  autoGenerated   Boolean             @default(false)
  nextScheduledDate DateTime?

  // System
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  createdBy       String?

  // Relations
  client          Client                    @relation(fields: [clientId], references: [id], onUpdate: NoAction)
  solarSystem     SolarSystem?              @relation(fields: [solarSystemId], references: [id], onUpdate: NoAction, onDelete: NoAction)
  order           Order?                    @relation(fields: [orderId], references: [id], onUpdate: NoAction, onDelete: NoAction)
  createdByUser   User?                     @relation(fields: [createdBy], references: [id], onUpdate: NoAction, onDelete: NoAction)

  // New relations
  technicians     MaintenanceTechnician[]
  parts           MaintenancePart[]
  statusHistory   MaintenanceStatusHistory[]
  inventoryMovements InventoryMovement[]

  @@map("maintenance_records")
}

// Growatt Integration
model GrowattCredentials {
  id       String @id @default(cuid())
  clientId String
  username String
  password String // Should be encrypted
  isActive Boolean @default(true)
  lastSync DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@unique([clientId])
  @@map("growatt_credentials")
}

model EnergyReading {
  id               String   @id @default(cuid())
  solarSystemId    String
  readingDate      DateTime
  dailyGeneration  Decimal? @db.Decimal(10, 3) // kWh
  totalGeneration  Decimal? @db.Decimal(12, 3) // kWh
  currentPower     Decimal? @db.Decimal(8, 3)  // kW
  co2Saved         Decimal? @db.Decimal(10, 3) // kg
  revenue          Decimal? @db.Decimal(10, 2) // Mexican Pesos

  // Weather data (optional)
  temperature      Decimal? @db.Decimal(5, 2)
  irradiance       Decimal? @db.Decimal(8, 2)

  createdAt        DateTime @default(now())

  solarSystem SolarSystem @relation(fields: [solarSystemId], references: [id], onDelete: Cascade)

  @@unique([solarSystemId, readingDate])
  @@map("energy_readings")
}

// Cached Growatt Data for faster dashboard loading (current day only)
model GrowattDataCache {
  id               String   @id @default(cuid())
  clientId         String
  plantName        String?
  plantId          String?

  // Energy data
  dailyGeneration  Decimal? @db.Decimal(10, 3) // kWh today
  monthlyGeneration Decimal? @db.Decimal(12, 3) // kWh this month
  yearlyGeneration Decimal? @db.Decimal(12, 3) // kWh this year
  totalGeneration  Decimal? @db.Decimal(12, 3) // kWh lifetime
  currentPower     Decimal? @db.Decimal(8, 3)  // kW current power

  // Additional metrics
  co2Reduction     Decimal? @db.Decimal(10, 3) // kg CO2
  revenue          Decimal? @db.Decimal(10, 2) // Mexican Pesos

  // Status
  status           String?  // online, offline, error
  lastUpdateFromGrowatt DateTime?

  // Cache metadata
  cachedAt         DateTime @default(now())
  expiresAt        DateTime
  isStale          Boolean  @default(false)

  // Error tracking
  fetchError       String?
  errorCount       Int      @default(0)
  lastErrorAt      DateTime?

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@unique([clientId])
  @@index([expiresAt])
  @@index([isStale])
  @@map("growatt_data_cache")
}

// Daily historical data from Growatt for charts and analytics
model GrowattDailyHistory {
  id               String   @id @default(cuid())
  clientId         String
  date             DateTime @db.Date // Date of the reading (no time component)
  plantName        String?
  plantId          String?

  // Energy data for this specific day
  dailyGeneration  Decimal  @db.Decimal(10, 3) // kWh generated this day
  monthlyGeneration Decimal? @db.Decimal(12, 3) // kWh this month (cumulative at time of reading)
  yearlyGeneration Decimal? @db.Decimal(12, 3) // kWh this year (cumulative at time of reading)
  totalGeneration  Decimal? @db.Decimal(12, 3) // kWh lifetime (cumulative at time of reading)

  // Snapshot metrics
  currentPower     Decimal? @db.Decimal(8, 3)  // kW at time of reading
  co2Reduction     Decimal? @db.Decimal(10, 3) // kg CO2 (cumulative)
  revenue          Decimal? @db.Decimal(10, 2) // Mexican Pesos (cumulative)

  // Status at time of reading
  status           String?  // online, offline, error

  // Metadata
  recordedAt       DateTime @default(now()) // When this record was created
  createdAt        DateTime @default(now())

  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@unique([clientId, date]) // One record per client per day
  @@index([clientId, date])
  @@index([date])
  @@map("growatt_daily_history")
}

// System Configuration
model SystemSettings {
  id    String @id @default(cuid())
  key   String @unique
  value String
  type  String @default("string") // string, number, boolean, json
  description String?
  updatedAt DateTime @updatedAt

  @@map("system_settings")
}

// Audit Log
model AuditLog {
  id        String   @id @default(cuid())
  userId    String?
  action    String   // CREATE, UPDATE, DELETE, LOGIN, LOGOUT
  resource  String   // users, clients, orders, etc.
  resourceId String?
  oldValues String? // JSON as string
  newValues String? // JSON as string
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  @@map("audit_logs")
}

// Maintenance Technician Assignment (many-to-many)
model MaintenanceTechnician {
  id              String   @id @default(cuid())
  maintenanceId   String
  technicianId    String
  role            String?  // "Lead", "Assistant", etc.
  assignedAt      DateTime @default(now())

  maintenance MaintenanceRecord @relation(fields: [maintenanceId], references: [id], onDelete: Cascade)
  technician  User              @relation(fields: [technicianId], references: [id], onDelete: Cascade)

  @@unique([maintenanceId, technicianId])
  @@map("maintenance_technicians")
}

// Maintenance Parts (inventory items used)
model MaintenancePart {
  id              String   @id @default(cuid())
  maintenanceId   String
  inventoryItemId String
  quantity        Int
  notes           String?
  createdAt       DateTime @default(now())

  maintenance   MaintenanceRecord @relation(fields: [maintenanceId], references: [id], onDelete: Cascade)
  inventoryItem InventoryItem     @relation(fields: [inventoryItemId], references: [id])

  @@map("maintenance_parts")
}

// Maintenance Status History (timeline of changes)
model MaintenanceStatusHistory {
  id            String            @id @default(cuid())
  maintenanceId String
  status        MaintenanceStatus
  notes         String?
  changedById   String
  changedAt     DateTime          @default(now())

  maintenance MaintenanceRecord @relation(fields: [maintenanceId], references: [id], onDelete: Cascade)
  changedBy   User              @relation(fields: [changedById], references: [id])

  @@map("maintenance_status_history")
}

// Maintenance Configuration (global settings)
model MaintenanceConfig {
  id               String   @id @default(cuid())
  equipmentType    String   // "solar_panels", "solar_heater", "general"
  intervalDays     Int      // Default: 90 (3 months)
  notifyDaysBefore Int      // Days before to send notification
  autoSchedule     Boolean  @default(true)
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@unique([equipmentType])
  @@map("maintenance_configs")
}

// In-App Notifications (for both Users and Clients)
model Notification {
  id        String    @id @default(cuid())
  userId    String?   // For admin/staff notifications
  clientId  String?   // For client notifications
  type      String    // "maintenance_scheduled", "maintenance_reminder", "maintenance_approved", etc.
  title     String
  message   String
  data      Json?     // Additional metadata
  read      Boolean   @default(false)
  readAt    DateTime?
  createdAt DateTime  @default(now())

  user   User?   @relation(fields: [userId], references: [id], onDelete: Cascade)
  client Client? @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([userId, read])
  @@index([clientId, read])
  @@index([createdAt])
  @@map("notifications")
}